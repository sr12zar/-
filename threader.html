<!DOCTYPE html>
<html lang = "th-TH">
<head>
 <meta charset = "utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>อ่าน ไทย</title>
<style>
   @page { size: 21cm 29.7cm; margin: 2cm }
p { margin-bottom: 0.25cm; background: transparent; line-height: 160%;}
button {
  background-color: yellow;
  border: 1px solid lime;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 2px 2px;
  cursor: pointer;
  border-radius: 25%;
}
.norm {
  display: inline-block;
  position: relative;   
}
.norm .help {
  visibility: hidden;
  background-color: #eee6dd;
  border-radius: 5%;
  padding: 4% 0;
  text-align: center;
  /* Position the help */
  position: absolute;
  z-index: 1;
  top: -9%;
  right: -1%;
}
.norm:hover .help {
  visibility: visible;
  font-size: 120% ;
  width: 140%;
  white-space: nowrap;
}

#tip {
  position: absolute;
  width: auto;
  background-color: #ffff99;
  z-index: 1;
}
</style>
</head>
<body style="text-align:center;">
<h1> อ่าน ก ข </h1>
<div>
<p id="chooseb"> เลือก หนังสือ... <input type="file" name="infile" id="infile">
<button id="btn" onclick="showb()" title="คลิก เปิดอ่าน หนังสือ">_อ่าน_</button>
</p>
<p id="braw"></p><!-- This is for checking content before reading -->
</div>
<p id="btitle" style="font-size: 48px; page-break-after: avoid; font-style: normal;"> </p>
<p id="Show" style="margin-bottom: 0.25cm; font-size: 36px; line-height: 160%;"> </p>
<!-- some work areas for selectionModify, + a tip on selected part of word/phrase -->
<div class="smx"></div>
<div id="tip" style='font-size: 36px; line-height: 160%;'></div>

<script> 
  document.getElementById("btn").style.display ="none";
  // get filename and content onload
  document.getElementById('infile')
        .addEventListener('change', function() {           
    var fr=new FileReader();
    fr.onload=function(){
      document.getElementById('braw')
               .textContent=fr.result;
      }      
    fr.readAsText(this.files[0]);
    document.getElementById("btn").style.display ="inline-block";
    // display 'raw'(pre) file content first
    document.getElementById("braw").style.display ="block";
    // destroy the reference to the FileReader for a new file 
    fr.remove; 
    } ); //add eventListener

var bk = "";   //*** use a global area to paint the book

function showb() { 
  document.getElementById("Show").innerHTML = "";
  
  let fn = (document.getElementById('infile').value).split(/[\\.]/); 
  let bt = fn[2]; // fn =[C:, fakepath, filename, extention]
  document.getElementById("btitle").innerHTML = tf(bt,1); //title is 1st line
  // get raw book content then hide its display and the read button
  let bc = document.getElementById("braw").innerText; 
  document.getElementById("braw").style.display ="none";
  document.getElementById("btn").style.display ="none";
  document.getElementById("tip").style.display ="none";
  bk = ""; 
  let bw = bc.split(" ");  // split content by nonblank space
  bw.forEach(mkw); //paint words
 
  document.getElementById("Show").innerHTML = bk;
}

function mkw(word, ix, bw) { 
  if (word=="--") bk += "<br>";
  else 
     bk += "<div class='norm'>&nbsp" + word 
        + "<span class='help'>" + selmod(word) + "</span></div>";
}

function selmod(word) {
// some words are long compound of simpler 'words'
// split again and paint with tf() --using Selection>Modify() on hidden smx div
  const smx = document.querySelector('.smx');
  smx.innerHTML=word; 
  const sel = window.getSelection(); // our selection api
  var mtx = ""; //clear mtx; set Selection.Modify ('extend'. 'forward', 'word')          
  sel.collapse(smx, 0);
  var start = 0;
  var end = 0;
  let len = smx.textContent.length; 
  //alert("len of text=" + len);
  while(end < len) { 
    sel.modify('extend', 'forward', 'word');
    end = sel.focusOffset;
    const ws = smx.textContent.substring(start, end);
      start = end;
      //alert("ws=" + ws + " start=" + start + " end=" + end); 
      mtx += tf(ws, 0) + " ";
  }
  smx.innerHTML = ""; // effectively turn display off
  return mtx ;
}

function tf(word, sp) { 
// a simple word painting function allows blanks and special chars
  var wt = ""; 
  let ws = (sp==1) ? word : thmod(word); // add spaces betw syllables
  for (let i=0; i<ws.length; i++) { 
    if (ws[i] !== " ") {
      wt += "<span style='color: " + paint(ws,i) + "';>" + ws[i] + "</span>";
      }
  }
  return wt;
}

function paint(ws, i) {
//paint the letter x by type -- อ, ว. ย can be consonant or vowel depending on neighbors
  const conso = "[กจฎฏดตบป.คฅฆงชซฌญฑฒณทธนพฟภมยรลวฬฮ,ขฃฉฐถผฝศษสห]"; // -อ
  const vowel = "[\ะ\า\ิ\ี\ึ\ื\ุ\ู\เ\แ\โ\อ\ไ\ใ\ั\็\ำ]"; // +อ assumed vowel
  const tones = "[\่\้\๊\๋\็]";
  const numer = "[0123456789.๐๑๒๓๔๕๖๗๘๙]";
//  const specl = "[ๆฯ\์\'\"\|\(\)\{\}\!\?\<\>\*\&\%\@\!\#\+\-\=\\\/]"; //** NO special chars
  var x = ws[i];
  if (x == " ") {return " ";} 
  else if (x == "อ" && i == 0) {cc = "#0000ff";} //blue อ 1st char deems conso
  else if (numer.search(x) > 0) {cc = "#800080";} //purple
  else if (tones.search(x) > 0) {cc = "#ff002b";} //red  
  else if (conso.search(x) > 0) {cc = "#0000ff";} //blue    
  else if (vowel.search(x) > 0) {cc = "#ff6e00";} //orange
    else  /* specl included */  {cc = "#9B2335";} //red pepper

  return cc;
}

function thmod(tx) {
// split by some front and end vowels 
  let t1 = tx.replace(/เ/g, " เ");
  let t2 = t1.replace(/แ/g, " แ");
  let t3 = t2.replace(/โ/g, " โ");
  let t4 = t3.replace(/ไ/g, " ไ");
  let t5 = t4.replace(/ใ/g, " ใ");
  let t6 = t5.replace(/ำ/g, "ำ ");
  let t7 = t6.replace(/ะ/g, "ะ ");
  let t8 = t7.replace(/์/g, "์ "); 
  return t8.replace(/\ +/g, " ");
}

// fill the reader page
document.getElementById("Show").innerHTML = bk ;
</script>
<script src="script/thaiG2P.js"></script>
<script>
// Extra tips with analysis of selected portion of word/phrase
// getSelection does not work for 'input' field in Firefox!
window.onmouseup = (e) => {
  var tip = document.getElementById("tip");
  var sel = window.getSelection().toString().trim();
  if (sel.length > 0) {
    var x = e.pageX -10;
    var y = e.pageY +30;
    console.log('selected:'+sel +' at x=' +x + ' y=' +y);
    
    tip.style.left = x + "px";
    tip.style.top = y + "px";
    var hvetn = g2p(sel); h=hvetn[0]; v=hvetn[1]; e=hvetn[2]; t=hvetn[3];
    var ttx = "&nbsp<span style='color: #0000ff';> " + h + "</span>"
             +"<span style='color: #ff6e00';> " + v + "</span>"
             +"<span style='color: #0066cc';> " + e + "</span>"
             +"<span style='color: #9B2335';> " + t + "</span>&nbsp";
    tip.innerHTML = ttx;
    tip.style.display = 'block';
    return true;
  } else {
    tip.style.display = 'none';
  }
}
</script>

</body>
</html>

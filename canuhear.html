<!DOCTYPE html>
<html>
<style>
button {
  width: 40px;
  height: 40px;
}
#container {
  width: 300px;
  height: 300px;
  position: relative;
  background: black;
  margin: 20px;
}
#animate {
  width: 5px;
  height: 5px;
  border: 1px dotted yellow;
  border-radius: 50%;
  position: absolute;
  background-color: lime;
}

</style>
<body>
<h2>‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÑ‡∏´‡∏°</h2>
<div>
 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å... 
 <input type="checkbox" id="earL"/>
   <label for="earL">*üéß</label> &nbsp
 <input type="checkbox" id="earR"/>
   <label for="earR">üéß*</label> &nbsp
 <input type="checkbox" id="earB"/>
   <label for="earB">*üéß*</label> &nbsp &nbsp 
 <input type="checkbox" id="setparms"/>
   <label for="setparms">‚öôÔ∏è</label>
</div>
<div id="settings">
<h2>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h2>
  <br>
  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà
  <input type="range" id="fIn" min="128" value="432" max="8219" oninput="show()" />
  <span id="fOut"></span><br>
  ‡πÅ‡∏ö‡∏ö
  <input type="range" id="tIn" min="0" value="0" max="3" oninput="show()" />
  <span id="tOut"></span><br>
  ‡∏î‡∏±‡∏á
  <input type="number" id="vIn" min="0" value="0.003" max="1" oninput="show()" />
  <span id="vOut"></span><br>
  ‡∏ô‡∏≤‡∏ô
  <input type="range" id="dIn" min="1" value= "125" max="1000" oninput="show()" />
  <span id="dOut"></span><br>
</div>
<button onclick="binTest()">‚ñ∂Ô∏è</button>&nbsp&nbsp<span id='msg1'>:</span>
<div id ="container">
  <div id ="animate"></div>
</div>

<script src="script/beeper2.js" type="text/javascript"></script>
<script>
let nTests=0; //count number of tests
show();

function show(){
  const setp = document.getElementById("settings");

  frequency = document.getElementById("fIn").value;
  document.getElementById("fOut").innerHTML=frequency + ' Hz';

  switch(document.getElementById("tIn").value * 1){
    case 0: type='sine'; break; 
    case 1: type='square'; break;
    case 2: type='sawtooth'; break;
    case 3: type='triangle'; break;
  }    
  document.getElementById("tOut").innerHTML=type;

  volume = document.getElementById("vIn").value;
  document.getElementById("vOut").innerHTML=volume;

  duration = document.getElementById("dIn").value;
  document.getElementById("dOut").innerHTML=duration + ' ms';
}

loops=0; //count number of iteration in loops
clicked=false;
canclick=false;
const con = document.getElementById("container");
const ball = document.getElementById("animate");

function setClick(){
  if (!canclick){
    con.addEventListener("click", score); 
    canclick=true;
    console.log("set click on");
  }
}
function removeClick(){
  if (canclick){
    con.removeEventListener("click", score); 
    canclick=false;
    console.log("remove click");
  }
}

function beepL(){ beep2(frequency,0,volume,duration, 0,0,0,0); }
function beepR(){ beep2(0,0,0,0, frequency,0,volume,duration); }
function beepB(){ beep2(frequency,0,volume,duration, frequency,0,volume,duration); }
function beepX(){
  console.log("beeping..f="+frequency+' v='+volume+' d='+duration);
  if (earL.checked) { beepL(); } 
  else if (earR.checked) { beepR(); }
  else if (earB.checked) { beepB(); }
}

//Hearing freq C3      C4      C5      c6       C7       C8       C9
Freqs=[64.22, 128.43, 256.87, 513.74, 1027.47, 2054.45, 4109.90, 8219.83];
Vols=[0.00013, 0.00025, 0.0005, 0.001, 0.002, 0.004, 0.008, 0.016, 0.032, 0.064, 0.128, 0.256];
//VoldB  -6dB  Rf  0dB   T 6dB m 12dB M 24dB  S 48dB P 48dB D 96dB ---amplified range---

//** try binary search on volume with (user)click as comparator(function)
//** threshold is the highest not-heard(unclicked) or the lowest heard (clicked) volume
function binTest() {
  var min=0; var max=Vols.length -1; //min=can't hear, max=can hear
  var ix = 5; //set starting at vol=0.002?
  clicked=false; //not-heard, heard is after a click
  var n=0; // limit run-away
  while (!(clicked && min<= max) && n<10) { //ideally found max=min+1 just!
    ix = Math.ceil((min+max)/2);
    test(ix); n++;
    if (clicked){
      console.log("binTest clicked min="+min+" max="+max+" ix="+ix);
      if (ix==min) return ix;    
      max=ix-1; // new max, same min 
    } else {
      console.log("binTest unclicked min="+min+" max="+max+" ix="+ix);
      if (ix==max) return ix;
      min=ix+1; // new min, same max  
    }
  }
  console.log("bintest ended n="+n+" min="+min+" ix="+IS+" max="+max); 
}

function test(ix) {
  volume = Vols[ix];
  console.log("binTest/test("+ix+") vol="+volume);
  mkTest();
}

function findex(f, far){
  for (let i=1; i<far.length; i++ ){
    if (f < far[i]) { return i-1; }
  }
}

function mkTest() {
  var rnd = 100+Math.floor(Math.random()*200); 
  let top = 0; 
  let left= 45+30*findex(frequency, Freqs); //skip col 1,
  let tid = setInterval(frame, 20); //every 10ms is fast
  function frame() {
    if (top > rnd && top <10+rnd) {
      clearInterval(tid);     
      setClick();
      if (canclick) {
        setTimeout(genbeeps(), 10); //delay by 10ms
        if (!canclick) {
           console.log("loops "+loops+" canclick="+canclick);
           return; //return;
        }        
        //setTimeout(removeClick,1000); //disallow click after 1s
      }
    } else {
      top++;
      if (top > 290) return;
      ball.style.top = top + "px"; 
      ball.style.left = left + "px";
    }
  }
}

function genbeeps(){
//make 3 consecutive beeps then timeout accepting clicks
  loops++;
  audioCtx.resume();
  const yn = (resolve, reject) => { 
    if (canclick) { resolve('now');} 
    else { reject('wait'); }     
    }
  const prom = new Promise(yn);
  prom.then( ()=>{setTimeout( beepX, 25);}); //wait 50ms before beep
  //prom.then( ()=>{setTimeout( beepX, 50+duration);}); //wait 100ms +duration
  //prom.then( ()=>{setTimeout( beepX, 75+2*duration);}); 
  prom.then( ()=>{setTimeout( removeClick, 1000);}); //disallow click after 1000ms
  prom.catch( ()=>{console.log("something is wrong.");}); 
}

function score(){
  //click when first hear something
  //plot a white symbol? then
  clicked=true;
  removeClick();
  nTests++;
  console.log("click out :"+ nTests +' loops '+ loops);
}
</script>

</body>
</html>
</script>

</body>
</html>
